<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Echo Room</title>
  <link rel="stylesheet" href="echo.css">
</head>
<body>
   <!-- Back Button (Image) -->
   <a href="javascript:history.back()" class="back-button">
    <img src="../../../public/img/back-arrow.png" alt="Back" />
  </a>
  <div class="container">
    <!-- Left Column (Chat Section) -->
    <div class="column left-column">
      <div class="card">
        <h1 style="text-align: center; width: 100%; margin-bottom: 20px; padding: 0;">Luma</h1>
        <div class="chat-box" id="chat-conversation">
          <!-- Messages will appear here -->
        </div>
        <div class="input-area">
          <input type="text" id="chat-input" placeholder="Type your message..." />
          <button id="send-message-button">Send</button>
        </div>
      </div>
    </div>
  
    <!-- Right Column (Folder Finding System) -->
    <div class="column right-column">
      <!-- Square 1 (Folder Finder 1) -->
      <div class="card" style="grid-row: 1; grid-column: 1; background-color: #f2f2f2;">
        <p>Folder 1</p>
        <!-- Editor Section (File and Folder Explorer) -->
  <div class="container">
    <textarea id="editor" readonly></textarea>
    <button id="newNoteBtn" disabled>New Note</button>
    <div id="fileExplorer"></div>
    <input type="text" id="pathInput" placeholder="Enter path here" />
    <button id="navigateToPathBtn">Navigate</button>
  </div>
        <button id="chooseFolderBtn1">Choose Folder 1</button>
      </div>

      <!-- Square 2 -->
      <div class="card" style="grid-row: 1; grid-column: 2; background-color: #e6e6e6;">
        <p>Card 2</p>
      </div>

      <!-- Square 3 (Folder Finder 2) -->
      <div class="card" style="grid-row: 2; grid-column: 1; background-color: #d9d9d9;">
        <p>Folder 2</p>
        <button id="chooseFolderBtn2">Choose Folder 2</button>
      </div>

      <!-- Square 4 -->
      <div class="card" style="grid-row: 2; grid-column: 2; background-color: #cccccc;">
        <p>Card 4</p>
      </div>
    </div>
  </div>

  

  <script>
    // Chat Section
    const chatEndpoint = "http://localhost:5000/chat";
    const chatConversation = document.getElementById("chat-conversation");
    const chatInput = document.getElementById("chat-input");
    const sendMessageButton = document.getElementById("send-message-button");

    function appendMessage(content, isUser, interactionKey = null) {
      const messageElement = document.createElement("div");
      messageElement.className = isUser ? "user-message" : "ai-message";
      messageElement.textContent = content;

      if (!isUser && interactionKey) {
        messageElement.addEventListener("dblclick", () => {
          const inputField = document.createElement("input");
          inputField.value = content;
          messageElement.textContent = "";
          messageElement.appendChild(inputField);
          inputField.focus();

          inputField.addEventListener("blur", () => {
            const updatedResponse = inputField.value.trim();
            if (updatedResponse !== content) {
              fetch("http://localhost:5000/edit_response", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  interaction_key: interactionKey,
                  updated_response: updatedResponse
                })
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  messageElement.textContent = updatedResponse;
                } else {
                  alert("Failed to update response.");
                  messageElement.textContent = content;
                }
              })
              .catch(error => {
                alert("Error: Unable to update response.");
                messageElement.textContent = content;
              });
            } else {
              messageElement.textContent = content;
            }
          });
        });
      }

      chatConversation.appendChild(messageElement);
      chatConversation.scrollTop = chatConversation.scrollHeight;
    }

    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      appendMessage(message, true);
      chatInput.value = "";

      try {
        const response = await fetch(chatEndpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await response.json();

        if (data.response) {
          const interactionKey = data.interaction_key;
          appendMessage(data.response, false, interactionKey);
        } else {
          appendMessage("Error: No response from AI server.", false);
        }
      } catch (error) {
        appendMessage("Error: Unable to connect to AI server.", false);
      }
    }

    sendMessageButton.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") sendMessage();
    });

    // File and Folder Explorer Section
    const { ipcRenderer } = require('electron');
    const fs = require('fs');
    const path = require('path');

    const editor = document.getElementById('editor');
    const newNoteBtn = document.getElementById('newNoteBtn');
    const fileExplorer = document.getElementById('fileExplorer');
    const chooseFolderBtn1 = document.getElementById('chooseFolderBtn1');
    const chooseFolderBtn2 = document.getElementById('chooseFolderBtn2');
    const pathInput = document.getElementById('pathInput');
    const navigateToPathBtn = document.getElementById('navigateToPathBtn');

    let currentFilePath = null;
    let currentDirectory = null;

    editor.readOnly = true;
    newNoteBtn.disabled = true;

    navigateToPathBtn.addEventListener('click', () => {
      const enteredPath = pathInput.value.trim();
      if (enteredPath) {
        navigateToPath(enteredPath);
      } else {
        alert('Please enter a valid path.');
      }
    });

    pathInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const enteredPath = pathInput.value.trim();
        if (enteredPath) {
          navigateToPath(enteredPath);
        } else {
          alert('Please enter a valid path.');
        }
      }
    });

    function navigateToPath(directoryPath) {
      fs.readdir(directoryPath, { withFileTypes: true }, (err, files) => {
        if (err) {
          alert('Error opening path: ' + err.message);
        } else {
          currentDirectory = directoryPath;
          loadDirectory(currentDirectory);
        }
      });
    }

    function loadDirectory(directoryPath) {
      if (!directoryPath) {
        alert('No folder selected. Please choose a folder first.');
        return;
      }

      currentDirectory = directoryPath;
      pathInput.value = currentDirectory;

      fs.readdir(directoryPath, { withFileTypes: true }, (err, files) => {
        if (err) {
          alert('Error reading directory: ' + err.message);
          return;
        }

        fileExplorer.innerHTML = '';

        const backButton = document.createElement('button');
        backButton.textContent = 'Back';
        backButton.style.marginBottom = '10px';
        backButton.addEventListener('click', navigateBack);
        fileExplorer.appendChild(backButton);

        const folderBreadcrumb = document.createElement('div');
        folderBreadcrumb.textContent = `Folder: ${directoryPath}`;
        folderBreadcrumb.classList.add('folder-breadcrumb');

        files.forEach(file => {
          const filePath = path.join(directoryPath, file.name);
          const fileElement = document.createElement('div');
          const fileText = document.createElement('span');
          fileText.textContent = file.name;

          fileElement.style.cursor = 'pointer';
          fileElement.classList.add(file.isDirectory() ? 'folder' : 'file');
          fileElement.appendChild(fileText);

          fileElement.addEventListener('click', () => {
            if (file.isDirectory()) {
              loadDirectory(filePath);
            } else {
              loadFile(filePath);
            }
          });

          fileExplorer.appendChild(fileElement);
        });

        editor.readOnly = false;
        newNoteBtn.disabled = false;
      });
    }

    function loadFile(filePath) {
      if (!filePath) return;

      fs.readFile(filePath, 'utf8', (err, data) => {
        if (err) {
          alert('Error opening file: ' + err.message);
        } else {
          editor.value = data;
          currentFilePath = filePath;
          editor.readOnly = false;
        }
      });
    }

    newNoteBtn.addEventListener('click', () => {
      if (!currentDirectory) {
        alert('No folder selected. Please choose a folder first.');
        return;
      }

      const newFileName = `new-note-${Date.now()}.md`;
      const newFilePath = path.join(currentDirectory, newFileName);

      fs.writeFile(newFilePath, '', (err) => {
        if (err) {
          alert('Error creating new file: ' + err.message);
        } else {
          loadDirectory(currentDirectory);
          loadFile(newFilePath);
        }
      });
    });

    chooseFolderBtn1.addEventListener('click', () => {
      ipcRenderer.invoke('dialog:openDirectory').then((folderPath) => {
        if (folderPath) {
          currentDirectory = folderPath;
          loadDirectory(currentDirectory);
        }
      }).catch((err) => {
        alert('Error selecting folder: ' + err.message);
      });
    });

    chooseFolderBtn2.addEventListener('click', () => {
      ipcRenderer.invoke('dialog:openDirectory').then((folderPath) => {
        if (folderPath) {
          currentDirectory = folderPath;
          loadDirectory(currentDirectory);
        }
      }).catch((err) => {
        alert('Error selecting folder: ' + err.message);
      });
    });
  </script>
</body>
</html>
