<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
  <title>Road Map</title>
  <link rel="stylesheet" href="./chat.css">
</head>
<body>
  <!-- Back Button (Image) -->
  <a href="javascript:history.back()" class="back-button">
    <img src="../../../public/img/back-arrow.png" alt="Back" />
  </a>

  <div class="lumachat-container">
    <!-- Left Column -->
    <div class="column-left">
      <div class="box">
        <!-- Chat Section -->
        <div class="luma-box-chat">
          <h3>Chat with Luma</h3>
          <div class="box-luma-conversation"></div>
          <!-- Container for the input box and send button -->
          <div class="chat-input-container">
            <input class="luma-box-chat-input" type="text" placeholder="Type a message..." />
            <!-- Send message button as an image -->
            <button class="send-message-button">
              <img src="../../../public/img/sendbutton.png" alt="Send Message" />
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="column-right">
      <div class="box">
        <div class="notes-box-chat">
            <h3>Note Editor</h3>
            <textarea id="editor" placeholder="Type your text here..." class="texteditor"></textarea>
            <button id="newNoteBtn" class="newnote">New Note</button>
            <button id="openBtn" class="opennote">Open Note</button>
            <button id="saveBtn" class="savenote">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    
    const editor = document.getElementById('editor');
    const openBtn = document.getElementById('openBtn');
    const saveBtn = document.getElementById('saveBtn');
    const newNoteBtn = document.getElementById('newNoteBtn');

    // Initialize current file path
    let currentFilePath = null;

    // Open file dialog to select a file
    openBtn.addEventListener('click', () => {
      ipcRenderer.invoke('dialog:open').then(filePath => {
        if (filePath) {
          currentFilePath = filePath; // Set current file path to the opened file
          const fs = require('fs');
          fs.readFile(filePath, 'utf8', (err, data) => {
            if (err) {
              alert('Error opening file: ' + err.message);
            } else {
              editor.value = data; // Load file content into the editor
            }
          });
        }
      }).catch(err => {
        alert('Error: ' + err.message);
      });
    });

    // Save edited content back to the file
    saveBtn.addEventListener('click', () => {
      ipcRenderer.invoke('dialog:save', currentFilePath).then(filePath => {
        if (filePath) {
          currentFilePath = filePath; // Update the current file path with the new location
          const fs = require('fs');
          
          // Save the file content
          fs.writeFile(filePath, editor.value, (err) => {
            if (err) {
              alert('Error saving file: ' + err.message);
            } else {
              alert('File saved successfully!');
              
              // Clear the editor content after saving
              editor.value = '';
              
              // Reset the current file path as we are now working with a new file
              currentFilePath = null;

              // Simulate clicking out and back in (blur and focus)
              editor.blur(); // First blur the editor
              setTimeout(() => {
                editor.focus(); // Then focus back on the editor
                editor.setSelectionRange(0, 0); // Set the cursor at the start
              }, 50); // Slight delay for the blur/focus events to take effect
            }
          });
        }
      }).catch(err => {
        alert('Error: ' + err.message);
      });
    });

    // Create a new note, save it, and open it in the editor
    newNoteBtn.addEventListener('click', () => {
      ipcRenderer.invoke('dialog:save', currentFilePath).then(filePath => {
        if (filePath) {
          currentFilePath = filePath; // Set current file path for the new file
          const fs = require('fs');
          
          // Create a new file and immediately open it in the editor
          fs.writeFile(filePath, '', (err) => {
            if (err) {
              alert('Error creating new file: ' + err.message);
            } else {
              editor.value = ''; // Clear editor for the new note
              editor.focus(); // Focus on the editor immediately
              alert('New file created successfully!');
              
              // Directly read the newly created file into the editor without opening another dialog
              fs.readFile(filePath, 'utf8', (err, data) => {
                if (err) {
                  alert('Error opening the new file: ' + err.message);
                } else {
                  editor.value = data; // Load the newly created file into the editor
                }
              });
            }
          });
        }
      }).catch(err => {
        alert('Error: ' + err.message);
      });
    });
  </script>
</body>
</html>
